{%- comment -%}
  Recursive children navigation. Works with both `subcategories` and `children`.
{%- endcomment -%}

{%- if page.has_children == false -%}
  {%- assign nav_children = "" | split: "" -%}
{%- else -%}
  {%- capture site_nav -%}
    {%- include_cached components/site_nav.html all=true -%}
  {%- endcapture -%}

  {%- assign nav_children = nil -%}

  {%- capture nav_list_link -%}
  <a href="{{ page.url | relative_url }}" class="nav-list-link"></a>
  {%- endcapture -%}

  {%- assign nav_child_start = site_nav | split: nav_list_link | last | split: "</a>" | slice: 1 | first -%}

  {%- assign nav_child_test = nav_child_start | remove_first: "<ul class=\"nav-list\">" | prepend: "<ul class=\"nav-list\">" -%}

  {%- if nav_child_start != nav_child_test -%}
    {%- assign nav_children = "" | split: "" -%}
  {%- endif -%}
{%- endif -%}

{%- unless nav_children -%}

  {%- assign nav_ancestors = "" | split: "" -%}
  {%- for nav_link in nav_breadcrumbs -%}
    {%- assign nav_title = nav_link | split: ">" | slice: 1 | first | append: ">" | remove: "</a>" -%}
    {%- assign nav_ancestors = nav_ancestors | push: nav_title -%}
  {%- endfor -%}

  {%- assign nav_parenthood = site[page.collection] | default: site.html_pages | where_exp: "item", "item.title != nil" | group_by: "parent" -%}

  {%- assign nav_top_nodes = nav_parenthood | where_exp: "item", "item.name == ''" | map: "items" | first -%}

  {%- assign nav_top_node_titles = nav_top_nodes | map: "title" -%}

  {%- include components/nav/children.html node=page ancestors=nav_ancestors all=true -%}

{%- endunless -%}

{%- if nav_children.size >= 1 -%}

  {%- if page.child_nav_order == 'desc' or page.child_nav_order == 'reversed' -%}
    {%- assign nav_children = nav_children | reverse -%}
  {%- endif -%}

<hr>
{% include toc_heading_custom.html %}

<ul class="nav-list">
  {% macro render_nav(navlist) %}
    <ul class="nav-list">
      {% for nav in navlist %}
        {% assign has_children = nav.subcategories | default: nav.children %}
        {% assign active_class = "" %}
        {% if page.path == nav.page %}
          {% assign active_class = "active" %}
        {% endif %}
        
        <li class="nav-list-item {{ active_class }}">
          {% if has_children %}
            <a href="#" class="nav-list-expander">
              <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg>
            </a>
          {% endif %}
          
          <a class="nav-list-link" href="{% link {{ nav.page }} %}">{{ nav.title }}</a>
          
          {% if has_children %}
            {% render_nav has_children %}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endmacro %}
  
  {% render_nav nav_children %}
</ul>

{%- endif -%}
